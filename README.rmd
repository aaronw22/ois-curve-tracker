---
output: github_document
always_allow_html: true
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)

library(data.table)
library(ggplot2)
library(readrba)
```

# ASX Implied Cash Rate

This repo automatically scrapes the ASX 30 Day Interbank Cash Rate Futures Implied Yield Curve from [here](https://www.asx.com.au/data/trt/ib_expectation_curve_graph.pdf) and converts it into a simple csv.

## Implied yield curve

```{r load-data, include=FALSE}
all_data <- fread("combined-data/all_data.csv", colClasses = c("Date", "numeric", "Date"))

ocr <- setDT(read_rba_seriesid("ARBAMPCNCRT"))
ocr <- ocr[date == max(date), value]

```

```{r graph-main, echo=FALSE, dev='svg', warning=FALSE}

# We can't graph all the days because it is far too messy now
# So grab a weekly sequence of data
past_seq <- seq.Date(max(all_data$scrape_date) - 7*8, max(all_data$scrape_date) - 1, by = "1 week")

ggplot() +
  geom_line(aes(x = date, y = cash_rate, colour = factor(scrape_date)), size = 1, data = all_data[scrape_date %in% past_seq]) +
  geom_line(aes(x = date, y = cash_rate), colour = "black", size = 1.2, data = all_data[scrape_date == max(scrape_date)]) +
  geom_hline(yintercept = ocr, colour = "black", size = 0.8, linetype = "dotted") +
  labs(
    title = "Implied Cash Rate over Past 8 Weeks",
    subtitle = paste0(format(max(all_data$scrape_date), "%d %b %Y"), " in bolded black, dotted line = current OCR"),
    x = "Date", y = "Implied cash rate (%)", colour = "Date") +
  scale_x_date(date_labels = "%b %Y", date_breaks = "3 months", date_minor_breaks = "1 month") +
  scale_colour_viridis_d(labels = function(x) format(as.Date(x), "%d %b"), guide = guide_legend(reverse = TRUE)) +
  theme_bw()

```

```{r graph-change, echo=FALSE, dev='svg', warning=FALSE}
# Graph the change in the implied cash rate between the past 2 days, past week and past 4 weeks

change_data <- all_data[scrape_date %in% c(max(scrape_date), max(scrape_date) - 1, max(scrape_date) - 7, max(scrape_date) - 28)]

change_data <- dcast(change_data, date ~ scrape_date, value.var = "cash_rate")
setnames(change_data, new = c("date", "4 weeks ago", "1 week ago", "1 day ago", "today"))
cols <- c("4 weeks ago", "1 week ago", "1 day ago")
change_data[, (cols) := lapply(.SD, function(x) today - x), .SDcols = cols]
change_data[, today := NULL]
change_data <- melt(change_data, id.vars = "date")
change_data[, variable := ordered(variable, c("1 day ago", "1 week ago", "4 weeks ago"))]

ggplot(change_data, aes(x = date, y = value, fill = variable)) +
  geom_col(position = "dodge") +
  labs(title = "Change in Implied Cash Rate",
       x = "Date", y = "Change in implied cash rate (ppt)") +
  scale_x_date(date_labels = "%b %Y", date_breaks = "3 months", date_minor_breaks = "1 month") +
  theme_bw()

```

```{r graph-peak, echo=FALSE, dev='svg', warning=FALSE}

peak_data <- all_data[, .(date = date[cash_rate == max(cash_rate, na.rm = TRUE)], cash_rate = max(cash_rate, na.rm = TRUE)), by = .(scrape_date)]

# Keep the first peak rate
peak_data <- peak_data[complete.cases(peak_data)]
peak_data <- unique(peak_data, by = "scrape_date")

ggplot(peak_data, aes(x = scrape_date, y = cash_rate)) +
  geom_hline(yintercept = ocr, colour = "black", size = 0.8, linetype = "dotted") +
  geom_line(colour = "#006d2c") +
  labs(title = "Implied Terminal Cash Rate",
       subtitle = "Dotted line = current OCR",
       x = "Data scrape date", y = "Implied terminal cash rate (%)") +
  scale_x_date(date_labels = "%b %Y", date_breaks = "2 months", date_minor_breaks = "1 month") +
  theme_bw()

ggplot(peak_data, aes(x = scrape_date, y = date)) +
  geom_line(colour = "#08519c") +
  labs(title = "Implied Month Terminal Cash Rate Reached",
       x = "Data scrape date", y = NULL) +
  scale_x_date(date_labels = "%b %Y", date_breaks = "2 months", date_minor_breaks = "1 month") +
  scale_y_date(date_labels = "%b %y", date_breaks = "1 months") +
  theme_bw()

```

```{r graph-first-cut, echo=FALSE, dev='svg', warning=FALSE}
graph_data <- copy(all_data)
graph_data[, peak_rate := max(cash_rate), by = scrape_date]
graph_data[, below := cash_rate < peak_rate - 0.25]
graph_data[, rising := cash_rate < shift(cash_rate, -1), by = scrape_date]
graph_data[rising == TRUE, below := FALSE] # Stops the hiking cycle being picked up as a drop
graph_data[, below := as.numeric(below)]
graph_data[, below := cumsum(below), by = scrape_date]
graph_data <- unique(graph_data[below == 1], by = c("scrape_date", "below"))

# Data prior to Feb 23 is a bit funky because it was still peak hiking cycle
graph_data <- graph_data[scrape_date > "2023-02-01"]

ggplot(graph_data, aes(x = scrape_date, y = date)) +
  geom_line(colour = "#08519c") +
  labs(title = "Implied Month of First Cash Rate Cut",
       x = "Data scrape date", y = NULL) +
  scale_x_date(date_labels = "%b %Y", date_breaks = "2 months", date_minor_breaks = "1 month") +
  scale_y_date(date_labels = "%b %y", date_breaks = "1 months", minor_breaks = NULL) +
  theme_bw()

```


```{r graph-total-cuts, echo=FALSE, dev='svg', warning=FALSE}

graph_data <- copy(all_data)
graph_data <- graph_data[!is.na(cash_rate)]
graph_data <- 
  graph_data[, .(peak_rate = max(cash_rate), end_rate = cash_rate[date == max(date)]), by = scrape_date]
graph_data[, change := end_rate - peak_rate]

ggplot(graph_data, aes(x = scrape_date, y = change)) +
  geom_line(colour = "#006d2c") +
  labs(title = "Implied Cash Rate Cuts by End of Data Period",
       x = "Data scrape date", y = "Change in cash rate (ppt)") +
  scale_x_date(date_labels = "%b %Y", date_breaks = "2 months", date_minor_breaks = "1 month") +
  scale_y_continuous(sec.axis = sec_axis(trans = ~ . / -0.25, name = "Number of 0.25ppt cuts")) +
  theme_bw()


```